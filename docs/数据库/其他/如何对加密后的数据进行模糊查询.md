# 密文字段模糊检索方案

即如何对加密了的字段进行查询查询？

**场景**：

正规的运营管理后台是需要保护用户敏感数据防止泄漏的，用户敏感数据比如订单数据中用户姓名、手机号、支付账户（卡号等）、发货地址等信息，对于保密级别不是很高的内容一般只在后端服务器返回时做脱敏处理，但是有些敏感数据即便是公司内部员工也不应该可见，但是有时又需要对这些高敏感的数据进行查询（统计、报表等）；

**方案**：

+ **方案一**：

  如果只是在**少量数据范围查询**，可以在数据库层面实现解密算法函数，通过 `decode(key) like '%partial%'` 先解密后查询；

  基本没有这种适用场景。

  缺点：

  + 无法使用数据库索引、查询效率很低 
  + 无法用于摘要类加密算法加密的字段

+ **方案二**：

  如果**模糊检索规则比较固定**，可以从检索目标字段中分离出检索字符串，分段加密最后拼接保存；

  比如淘宝的密文字段检索方案中提供了一个案例：

  检索规则：支持根据4位英文字符（半角），2个中文字符（全角）为一个检索条件进行模糊查询；

  比如：`taobao123`, 都是英文字符，加密方式是这样的：分别对`taob`、`aoba`、...、`o123`进行加密，最后将各段的加密结果进行拼接存储到数据表，后面可以通过 `like '%xxxx%'` 检索符合条件的数据；

  这个只是大概的原理，实际上可以根据性能等要求这个方案进行定制；

  比如要求对手机号可以按中间4位数、结尾4位数字进行快速查询，就可以将中间4位数、结尾四位数字分别进行加密，分别存储到单独的字段中。

  缺点：

  + 只能针对固定规则；

**参考**：

+ [密文字段检索方案（淘宝）](https://open.taobao.com/docV3.htm?docId=106213&docType=1)
+ [加解密对接的典型方案（京东）](https://jos.jd.com/commondoc?listId=345)