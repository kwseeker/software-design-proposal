# 业务中应该如何正确使用线程池

首先应该过一遍源码熟悉线程池的工作原理；然后分析线程池使用可能出现的问题；针对问题制定对策。

**线程池的工作原理**：

简单说就是使用队列存储任务，线程池中维护一组工作者线程死循环不断从队列中提取任务并执行，非核心线程空闲超时会被关闭回收。

**线程池使用可能出现的问题**：

+ 队列的选择

  + 选择有界队列

    有界队列可以防止突发流量导致内存占用过高。

    但是可能导致队列占满，任务提交失败，需要监控队列空闲空间，在队列快要占满时需要报警；然后借助 K8S 拓展节点。

    如果万一队列占满需要记录上下文信息到数据库，便于恢复和补偿。

+ 线程数量的选择

  + 过多的线程可能导致处理效率反而下降

    先通过日志看IO和CPU耗时占比计算大概需要的线程数量，然后需要反复调整参数和压测找出最优线程数；但是前提是服务实例有独立的硬件资源配给。

+ 防止线程池任务丢失

  + 服务器宕机

    因意外导致的宕机一定会导致提交到线程池中的任务丢失，如果任务比较重要，可以**在任务提交前先持久化记录一下任务**，比如将任务保存到数据库，任务正常执行完毕的话去更新下任务执行状态，任务如果因宕机没执行或执行失败就设置一个定时任务扫描执行失败的任务进行重试或者手动处理。

    > 正常执行完毕的任务可以从表中删除获取移到其他表，防止表过大，拉低扫描效率。

  + 服务关闭

    服务关闭时需要在关闭钩子中调用线程池优雅关闭方法，带超时地等待队列中任务执行完毕。可能因为某些原因超时还没有处理完任务，需要借助上面的任务记录，进行后期恢复或补偿。

